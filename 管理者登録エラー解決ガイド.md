# 管理者登録エラー解決ガイド

## 📋 問題

「管理者登録に失敗しました」というエラーが表示されます。

## 🔍 トラブルシューティング手順

### ステップ1: ブラウザのコンソールを確認

1. **開発者ツールを開く**
   - ブラウザで `F12` キーを押す
   - または右クリック → 「検証」を選択

2. **Consoleタブを確認**
   - 登録を試すと、エラーログが表示されます
   - エラーメッセージの詳細を確認してください

3. **Networkタブを確認**
   - Networkタブを開く
   - 登録を試す
   - `/api/admin/register` のリクエストを確認
   - レスポンスの内容を確認

### ステップ2: Vercelのログを確認

1. **Vercelダッシュボードにアクセス**
   - https://vercel.com/dashboard

2. **プロジェクトを選択**
   - `cmsbeppin` プロジェクトを選択

3. **Logsタブを確認**
   - 「Logs」タブをクリック
   - 登録を試した時刻のログを確認
   - エラーの詳細が表示されます

### ステップ3: データベースの確認（最も重要）

**問題の可能性**: 本番環境のSupabaseで `admin_users` テーブルが存在しない可能性があります。

#### 確認手順

1. **Supabaseダッシュボードにアクセス**
   - https://supabase.com/dashboard/project/hgcmbmcjzdfugbnljkel

2. **Table Editorを開く**
   - 左サイドバーから「Table Editor」をクリック

3. **admin_usersテーブルが存在するか確認**
   - テーブル一覧に `admin_users` が表示されるか確認
   - 存在しない場合は、データベーススキーマが実行されていません

#### 解決方法: データベーススキーマを実行

1. **SupabaseダッシュボードでSQL Editorを開く**
   - 左サイドバーから「SQL Editor」をクリック

2. **データベーススキーマを実行**
   - 「New query」をクリック
   - `supabase/point-card-schema.sql` の内容をコピー
   - SQL Editorに貼り付け
   - 「Run」ボタンをクリック

3. **確認**
   - エラーが表示されなければ成功
   - Table Editorで `admin_users` テーブルが表示されることを確認

### ステップ4: 環境変数の確認

1. **Vercelダッシュボードにアクセス**
   - https://vercel.com/dashboard

2. **プロジェクトを選択**
   - `cmsbeppin` プロジェクトを選択

3. **Settings → Environment Variablesを確認**
   - 以下の環境変数が設定されているか確認:
     - `NEXT_PUBLIC_SUPABASE_URL`
     - `NEXT_PUBLIC_SUPABASE_ANON_KEY`
     - `SUPABASE_SERVICE_ROLE_KEY`
     - `JWT_SECRET`
     - `JWT_EXPIRES_IN`

4. **すべての環境変数で「All Environments」が選択されているか確認**

### ステップ5: RLSポリシーの確認

1. **SupabaseダッシュボードでSQL Editorを開く**

2. **RLSポリシーを確認**
   ```sql
   SELECT schemaname, tablename, policyname 
   FROM pg_policies 
   WHERE schemaname = 'public' 
   AND tablename = 'admin_users'
   ORDER BY tablename, policyname;
   ```

3. **ポリシーが存在しない場合**
   - `supabase/point-card-schema.sql` を実行してポリシーを作成

## 🔧 よくある原因と解決方法

### 原因1: データベーステーブルが存在しない

**症状**: 「管理者登録に失敗しました」エラー

**解決方法**: 
- `supabase/point-card-schema.sql` を実行してテーブルを作成

### 原因2: 環境変数が設定されていない

**症状**: 「サーバー設定エラーが発生しました」エラー

**解決方法**:
- Vercelで環境変数を設定
- すべての環境変数で「All Environments」が選択されているか確認

### 原因3: RLSポリシーが正しく設定されていない

**症状**: 「管理者登録に失敗しました」エラー（データベースエラー）

**解決方法**:
- `supabase/point-card-schema.sql` を実行してRLSポリシーを作成
- または、サービスロールキーが正しく設定されているか確認

### 原因4: Supabase接続エラー

**症状**: ネットワークエラーまたはタイムアウト

**解決方法**:
- Supabaseプロジェクトがアクティブか確認
- インターネット接続を確認

## ✅ 確認チェックリスト

デプロイ完了後、以下を確認してください：

- [ ] ✅ データベーススキーマが実行されている（`admin_users` テーブルが存在する）
- [ ] ✅ 環境変数が正しく設定されている（Vercel）
- [ ] ✅ RLSポリシーが設定されている
- [ ] ✅ Vercelのデプロイが完了している
- [ ] ✅ ブラウザのコンソールにエラーが表示されない
- [ ] ✅ 管理者登録が成功する

## 🎉 解決後の確認

管理者登録が成功したら、以下を確認してください：

1. **管理者ログインが動作するか**
   - https://cmsbeppin.vercel.app/admin/login
   - 登録したメールアドレスとパスワードでログイン

2. **管理者ダッシュボードが表示されるか**
   - ログイン後、ダッシュボードが表示されることを確認

3. **エラーログがないか**
   - Vercelのログを確認
   - エラーが発生していないか確認

## 📝 次のステップ

管理者登録が成功したら：

1. **初期管理者アカウントを作成**
   - 強力なパスワードを設定
   - メールアドレスを確認

2. **セキュリティの確認**
   - 必要に応じて、管理者登録を制限することを検討
   - 定期的に管理者アカウントを監査

3. **動作確認**
   - すべての機能が正常に動作するか確認

お疲れ様でした！

