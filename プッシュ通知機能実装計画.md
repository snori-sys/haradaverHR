# プッシュ通知機能実装計画

## 📋 概要

店舗管理画面から、プッシュ通知で個別にオトクな情報などを配信できるようにする（メルマガの代替）。

## 🎯 実装する機能

1. **顧客側**
   - プッシュ通知の許可・登録機能
   - 通知設定の管理

2. **管理画面側**
   - 個別顧客への通知送信
   - 一括通知送信（全顧客）
   - 通知履歴の確認
   - 通知送信予約機能（オプション）

## 📝 実装ステップ

### ステップ1: データベーススキーマの追加 ✅

**ファイル**: `supabase/push-notifications-schema.sql`

追加するテーブル:
- `push_subscriptions` - プッシュ通知サブスクリプション（顧客ごとの通知登録情報）
- `push_notifications` - プッシュ通知履歴（送信した通知の記録）
- `push_notification_logs` - プッシュ通知送信ログ（各顧客への送信結果）

### ステップ2: 依存関係の追加

**必要なパッケージ**:
```bash
npm install web-push
```

**VAPIDキーの生成**:
```bash
npx web-push generate-vapid-keys
```

### ステップ3: 環境変数の設定

**Vercel環境変数に追加**:
- `VAPID_PUBLIC_KEY` - VAPID公開キー
- `VAPID_PRIVATE_KEY` - VAPID秘密キー
- `VAPID_MAILTO` - VAPID連絡先メールアドレス（例: `admin@example.com`）

### ステップ4: 顧客側の実装

#### 4-1. プッシュ通知登録コンポーネント

**ファイル**: `components/push-notification-subscribe.tsx`

機能:
- プッシュ通知の許可を求める
- 通知登録の実行
- 登録状態の表示

#### 4-2. 顧客ダッシュボードに通知設定を追加

**ファイル**: `app/dashboard/page.tsx` を更新

### ステップ5: APIルートの実装

#### 5-1. プッシュ通知サブスクリプション登録API

**ファイル**: `app/api/push/subscribe/route.ts`

機能:
- 顧客のプッシュ通知サブスクリプションを登録
- データベースに保存

#### 5-2. プッシュ通知送信API

**ファイル**: `app/api/admin/push/send/route.ts`

機能:
- 個別顧客への通知送信
- 一括通知送信
- Web Push APIを使用した実際の通知送信

### ステップ6: 管理画面の実装

#### 6-1. プッシュ通知送信ページ

**ファイル**: `app/admin/push-notifications/page.tsx`

機能:
- 通知タイトル・本文の入力
- 送信先の選択（個別・一括）
- 通知送信の実行
- 送信履歴の表示

#### 6-2. サイドバーにメニューを追加

**ファイル**: `components/app-sidebar.tsx` を更新

### ステップ7: Service Workerの実装

**ファイル**: `public/sw.js` または `public/service-worker.js`

機能:
- プッシュ通知の受信
- 通知クリック時の処理

## 🔧 技術詳細

### Web Push API

- **VAPID**: Voluntary Application Server Identification（サーバー認証）
- **Service Worker**: バックグラウンドで通知を処理
- **Push API**: ブラウザのプッシュ通知機能

### データフロー

1. **顧客が通知を許可**
   - ブラウザでプッシュ通知の許可を求める
   - Service Workerを登録
   - PushSubscriptionを取得

2. **サブスクリプションをサーバーに送信**
   - `/api/push/subscribe` にPOST
   - データベースに保存

3. **管理者が通知を送信**
   - 管理画面で通知内容を入力
   - `/api/admin/push/send` にPOST
   - Web Push APIで通知を送信

4. **顧客が通知を受信**
   - Service Workerが通知を受信
   - ブラウザに通知を表示

## 📋 実装チェックリスト

### データベース
- [ ] データベーススキーマを実行
- [ ] テーブルが正しく作成されているか確認

### 依存関係
- [ ] `web-push` をインストール
- [ ] VAPIDキーを生成

### 環境変数
- [ ] VAPID_PUBLIC_KEY を設定
- [ ] VAPID_PRIVATE_KEY を設定
- [ ] VAPID_MAILTO を設定

### 顧客側
- [ ] プッシュ通知登録コンポーネントを実装
- [ ] 顧客ダッシュボードに通知設定を追加
- [ ] Service Workerを実装

### APIルート
- [ ] サブスクリプション登録APIを実装
- [ ] 通知送信APIを実装

### 管理画面
- [ ] 通知送信ページを実装
- [ ] サイドバーにメニューを追加
- [ ] 送信履歴の表示を実装

## ⚠️ 注意事項

1. **HTTPS必須**: プッシュ通知はHTTPS環境でのみ動作します（VercelはHTTPS対応）

2. **ブラウザ対応**: 
   - Chrome/Edge: 対応
   - Firefox: 対応
   - Safari: iOS 16.4+で対応（限定的）

3. **ユーザー許可**: 
   - ユーザーが通知を許可しないと機能しません
   - ブラウザの通知設定で無効化されている場合は送信されません

4. **VAPIDキー**: 
   - 本番環境用のキーを生成する必要があります
   - 秘密キーは絶対に公開しないでください

## 🎉 完成後の機能

- ✅ 個別顧客への通知送信
- ✅ 全顧客への一括通知送信
- ✅ 通知履歴の確認
- ✅ 送信結果の確認（成功/失敗）
- ✅ 顧客が通知を受け取れる

## 📝 次のステップ

1. データベーススキーマを実行
2. 依存関係を追加
3. VAPIDキーを生成・設定
4. 段階的に実装を進める

